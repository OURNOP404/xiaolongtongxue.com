<!doctype html>
<!--
  Material Design Lite
  Copyright 2015 Google Inc. All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      https://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License
-->
<html lang="zh">
<head>
  {{template "header"}}
  <title>小龙同学</title>
</head>
<body>
<div class="demo-blog mdl-layout mdl-js-layout has-drawer is-upgraded">
  <main class="mdl-layout__content">
    <div id="grid" class="demo-blog__posts mdl-grid">
      {{range $i, $a := . -}}
      <div class="mdl-card mdl-cell {{if eq $i 0 -}}coffee-pic mdl-cell--8-col{{- else -}}on-the-road-again mdl-cell--12-col{{- end}}">
        <div class="mdl-card__media mdl-color-text--grey-50"
             style="{{if $a.Background | hasColor -}}background-color: {{$a.Background}}{{- end}}
             {{if $a.Background | hasImage -}}
             background-image: url('{{if $a.Background | relImage}}{{$a.Id}}/{{$a.Background}}{{else}}{{$a.Background}}{{end}}')
             {{- end}};">
          <h3{{if not $a.Summary}} class="quote"{{end}}><a href="{{$a.Id}}">{{$a.Title}}</a></h3>
        </div>
        {{if $a.Summary -}}
        <div class="mdl-color-text--grey-600 mdl-card__supporting-text">
          {{$a.Summary}}
        </div>
        {{- end}}
        <div class="mdl-card__supporting-text meta mdl-color-text--grey-600">
          <div class="minilogo"></div>
          <div>
            <strong>小龙同学</strong>
            <span>{{$a.Date | daysAgo}} 天前 {{if $a.Tags}} 在 {{$a.Tags | tags}}{{end}}
            </span>
          </div>
        </div>
      </div>
      {{if eq $i 0 -}}
      <div class="mdl-card something-else mdl-cell mdl-cell--8-col mdl-cell--4-col-desktop">
        <button id="code" class="mdl-button mdl-js-ripple-effect mdl-js-button mdl-button--fab mdl-color--accent">
          <i class="material-icons mdl-color-text--white" role="presentation">code</i>
          <span class="visuallyhidden">add</span>
        </button>
        <div class="mdl-card__media mdl-color--white mdl-color-text--grey-600">
          <img src="/assets/images/qrcode.jpg" />
          Java/Android Engineer; Gopher
        </div>
        <div class="mdl-card__supporting-text meta meta--fill mdl-color-text--grey-600">
          <div>
            <strong>小龙同学</strong>
          </div>
          <ul class="mdl-menu mdl-js-menu mdl-menu--bottom-right mdl-js-ripple-effect" for="menubtn">
            <li class="mdl-menu__item" id="about">About</li>
            <li class="mdl-menu__item">CC BY 4.0</li>
          </ul>
          <button id="menubtn" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
            <i class="material-icons" role="presentation">more_vert</i>
            <span class="visuallyhidden">show menu</span>
          </button>
        </div>
      </div>
      {{- end}}
      {{- end}}
      <nav id="nav" class="demo-nav mdl-cell mdl-cell--12-col">
        <div id="progress" class="mdl-progress mdl-js-progress mdl-progress__indeterminate"></div>
        <a id="more" class="demo-nav__button" title="show more">
          <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
            <i class="material-icons" role="presentation">arrow_downward</i>
          </button>
        </a>
      </nav>
    </div>
    {{template "footer"}}
  </main>
  <div class="mdl-layout__obfuscator"></div>
</div>

{{template "script"}}
<script type="application/javascript">
  Array.prototype.forEach.call(document.querySelectorAll('.mdl-card__media'), function (el) {
    go(el);
  });

  var p = 1;
  var size = 7;
  var lastLength = -1;

  var grid = document.getElementById('grid');
  var nav = document.getElementById('nav');
  var more = document.getElementById('more');
  var progress = document.getElementById('progress');
  var toast = document.getElementById('toast');

  document.getElementById('share').addEventListener('click', function () {
    toast.MaterialSnackbar.showSnackbar({message: 'not yet impl :)'});
  });
  document.getElementById('about').addEventListener('click', function () {
    window.open(window.location.protocol + '//' + window.location.host + '/misc/resume', '_blank');
  });
  document.getElementById('code').addEventListener('click', function () {
    window.open('https://github.com/longkai/xiaolongtongxue.com', '_blank');
  });

  // hide it first
  progress.style.width = '100%';
  progress.style.display = 'none';

  more.addEventListener('click', function () {
    if (lastLength != -1 && lastLength < size) {
      toast.MaterialSnackbar.showSnackbar({message: '没有更多啦'});
      return;
    }

    more.style.display = 'none';
    progress.style.display = 'block';

    ajax(
        'GET',
        '/pagination?p=' + p + '&size=' + size,
        function (data) {
          console.log(data);
          lastLength = data.length;
          p++;

          // do append
          for (var i = 0; i < data.length; i++) {
            var a = data[i];

            var card = document.createElement('div');
            card.className = 'mdl-card mdl-cell on-the-road-again mdl-cell--12-col';

            var cardMedia = document.createElement('div');
            cardMedia.className = 'mdl-card__media mdl-color-text--grey-50';
            if (hasColor(a.background)) {
              cardMedia.style.backgroundColor = a.background;
            } else if (hasImage(a.background)) {
              cardMedia.style.backgroundImage = 'url("' + background(a) + '")';
            }

            var h3 = document.createElement('h3');
            if (a.summary) {
              h3.className = 'quote';
            }
            var title = document.createElement('a');
            title.setAttribute('href', a.id);
            title.textContent = a.title;

            h3.appendChild(title);
            cardMedia.appendChild(h3);

            go(cardMedia); // handle click event

            // text field
            var meta = document.createElement('div');
            meta.className = 'mdl-card__supporting-text meta mdl-color-text--grey-600';
            var avatar = document.createElement('div');
            avatar.className = 'minilogo';
            meta.appendChild(avatar);

            var div = document.createElement('div');
            var author = document.createElement('strong');
            author.textContent = '小龙同学';
            var date = document.createElement('span');
            date.textContent = daysAgo(a.date) + ' 天前';

            // tags
            if (a.tags) {
              date.textContent += ' 在 ';
              for (var j = 0; j < a.tags.length; j++) {
                date.textContent += '#' + a.tags[j];
                if (j != a.tags.length - 1) {
                  date.textContent += ', ';
                }
              }
            }

            div.appendChild(author);
            div.appendChild(date);

            meta.appendChild(div);

            // add to card
            card.appendChild(cardMedia);
            // check has summary
            if (a.summary) {
              var summary = document.createElement('div');
              summary.className = 'mdl-color-text--grey-600 mdl-card__supporting-text';
              summary.textContent = a.summary;

              card.appendChild(summary);
            }
            card.appendChild(meta);

            // insert to page
            componentHandler.upgradeElement(card);
            grid.insertBefore(card, nav);
          }

          more.style.display = 'block';
          progress.style.display = 'none';
        },
        function (code) {
          console.log(code);
          more.style.display = 'block';
          progress.style.display = 'none';
          toast.MaterialSnackbar.showSnackbar({message: '出错了: ' + code});
        }
    );
  });

  function hasColor(s) {
    if (s) {
      return s.length != 0 && s[1] == '#';
    }
    return false;
  }

  function hasImage(s) {
    if (s) {
      return s.length != 0 && s[1] != '#';
    }
    return false;
  }

  function go(el) {
    var link = el.querySelector('a');
    if (!link) {
      return;
    }
    var target = link.getAttribute('href');
    if (!target) {
      return;
    }
    if (!target.startsWith('/')) {
      target = '/' + target
    }
    el.addEventListener('click', function () {
      window.open(window.location.protocol + '//' + window.location.host + target, '_blank');
    });
  }

  function background(a) {
    var bg = a.background;
    if (bg.charAt(0) == '/' || bg.lastIndexOf('http://') == 0 || bg.lastIndexOf('https://') == 0) {
      return bg;
    }
    return a.id + '/' + bg;
  }
</script>
</body>
</html>
